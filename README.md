# AutoLLM-Compressor (CompactMind)

ä¸€ä¸ªå¯æ’æ‹”ã€å¯æ‰©å±•çš„å®Œå…¨æœ¬åœ°åŒ–è‡ªåŠ¨åŒ–å¤§æ¨¡å‹å‹ç¼©æ¡†æ¶ã€‚æ ¸å¿ƒè®¾è®¡ä¸ºâ€œæ³¨å†Œä¸­å¿ƒ + æœç´¢å¼•æ“ + æ‰§è¡Œå™¨ + è¯„ä¼°å™¨â€ï¼Œæ”¯æŒ Llama-2 ç­‰å¤§æ¨¡å‹åœ¨æœ¬åœ°ç¯å¢ƒä¸‹çš„è‡ªåŠ¨å‹ç¼©ä¸è¯„ä¼°ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

*   **å®Œå…¨æœ¬åœ°åŒ–**: æ”¯æŒåŠ è½½æœ¬åœ°æ¨¡å‹ï¼ˆå¦‚ Llama-2ï¼‰å’Œæœ¬åœ°æ•°æ®é›†ï¼ˆWikiText-2ï¼‰ï¼Œæ— éœ€è”ç½‘ï¼Œå®‰å…¨ç¨³å®šã€‚
*   **æ··åˆæ–¹æ³•æœç´¢ (Hybrid Search)**: è‡ªåŠ¨æœç´¢å•ä¸€æ–¹æ³•åŠç»„åˆæ–¹æ³•ï¼ˆå¦‚â€œé‡åŒ–+å‰ªæâ€ï¼‰ï¼Œå¹¶æ™ºèƒ½è¿‡æ»¤æ— æ•ˆç»„åˆï¼Œå¯»æ‰¾å¸•ç´¯æ‰˜æœ€ä¼˜è§£ã€‚
*   **è´å¶æ–¯ä¼˜åŒ– (Bayesian Optimization)**: é›†æˆ Optuna æ¡†æ¶ï¼Œæ”¯æŒé«˜æ•ˆçš„è‡ªåŠ¨åŒ–å‚æ•°æœç´¢ä¸å‰ªæã€‚
*   **æ’ä»¶åŒ–æ¶æ„**: å‹ç¼©ç®—æ³•ï¼ˆå‰ªæã€é‡åŒ–ï¼‰é€šè¿‡è£…é¥°å™¨æ³¨å†Œï¼Œé›¶ä¾µå…¥æ‰©å±•ã€‚
*   **çœŸå®è¯„ä¼°**: åŸºäº PPL (Perplexity) çš„é—­ç¯è¯„ä¼°ï¼Œæ‹’ç»éšæœºæ•°æ®ç³Šå¼„ã€‚
*   **å¯è§†åŒ–æŠ¥å‘Š**: è‡ªåŠ¨ç”Ÿæˆå‹ç¼©æ¯” vs PPL çš„å¸•ç´¯æ‰˜å‰æ²¿å›¾ (Pareto Frontier)ï¼Œç›´è§‚å±•ç¤ºä¸åŒæ–¹æ³•çš„æ€§èƒ½è¾¹ç•Œã€‚
*   **å®Œæ•´æ—¥å¿—ç³»ç»Ÿ**: è‡ªåŠ¨è®°å½•è¿è¡Œæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œæ–¹ä¾¿å¤ç°ä¸æ’æŸ¥ã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„è¯¦è§£

```text
AutoLLM-Compressor/
â”œâ”€â”€ core/                       # [æ ¸å¿ƒå¼•æ“]
â”‚   â”œâ”€â”€ compressor.py           # å‹ç¼©æ‰§è¡Œå™¨ï¼šæ”¯æŒå•æ–¹æ³•å’Œ Hybrid ç»„åˆæ‰§è¡Œ
â”‚   â”œâ”€â”€ engine.py               # æœç´¢å¼•æ“ï¼šå®ç° Grid Search åŠæ··åˆæ–¹æ³•æœç´¢
â”‚   â”œâ”€â”€ evaluator.py            # è¯„ä¼°å™¨ï¼šè®¡ç®—æ¨¡å‹çš„ PPL (å›°æƒ‘åº¦)
â”‚   â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ methods/                    # [ç®—æ³•ä»“åº“]
â”‚   â”œâ”€â”€ pruning/                # å‰ªæç®—æ³•
â”‚   â”‚   â”œâ”€â”€ random.py           # éšæœºå‰ªæ (Baseline)
â”‚   â”‚   â”œâ”€â”€ l2.py               # L2 ç»“æ„åŒ–å‰ªæ (Structured Pruning)
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ quantization/           # é‡åŒ–ç®—æ³•
â”‚   â”‚   â”œâ”€â”€ fp16.py             # FP16 åŠç²¾åº¦é‡åŒ–
â”‚   â”‚   â”œâ”€â”€ int8_sq.py          # INT8-SQ æ¨¡æ‹Ÿé‡åŒ– (SmoothQuant æ€æƒ³)
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”œâ”€â”€ base.py                 # ç®—æ³•åŸºç±»ï¼Œå®šä¹‰æ ‡å‡†æ¥å£
â”‚   â”œâ”€â”€ registry.py             # æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æ‰€æœ‰å¯ç”¨ç®—æ³•
â”‚   â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ utils/                      # [å·¥å…·ç±»]
â”‚   â”œâ”€â”€ data_loader.py          # æ•°æ®åŠ è½½å™¨
â”‚   â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ scripts/                    # [è¾…åŠ©è„šæœ¬]
â”‚   â”œâ”€â”€ download_model.py       # ä¸‹è½½æ¨¡å‹
â”‚   â”œâ”€â”€ download_from_modelscope.py # ä» ModelScope ä¸‹è½½
â”‚   â””â”€â”€ download_data.py        # ä¸‹è½½æ•°æ®é›†
â”‚
â”œâ”€â”€ results/                    # [ç»“æœè¾“å‡º]
â”‚   â””â”€â”€ result_YYYYMMDD-HHMMSS/ # ç‹¬ç«‹è¿è¡Œç›®å½•
â”‚       â”œâ”€â”€ run.log             # å®Œæ•´è¿è¡Œæ—¥å¿—
â”‚       â”œâ”€â”€ report.json         # è¯¦ç»†å®éªŒæŠ¥å‘Š
â”‚       â”œâ”€â”€ search_history.csv  # æœç´¢è¿‡ç¨‹æ•°æ®
â”‚       â””â”€â”€ picture/            # å¯è§†åŒ–å›¾è¡¨ç›®å½•
â”‚           â”œâ”€â”€ performance_analysis.png  # æœ€ç»ˆæ€§èƒ½å¯¹æ¯”å›¾
â”‚           â””â”€â”€ search_space_analysis.png # æœç´¢ç©ºé—´å¸•ç´¯æ‰˜å›¾
â”‚
â”œâ”€â”€ main.py                     # [ä¸»å…¥å£] é¡¹ç›®å¯åŠ¨æ–‡ä»¶
â””â”€â”€ README.md                   # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…ä¾èµ–
pip install torch transformers datasets modelscope matplotlib optuna
```

### 2. å‡†å¤‡æ¨¡å‹ä¸æ•°æ®
*   **ä¸‹è½½æ•°æ®**:
    ```bash
    python scripts/download_data.py
    ```
*   **ä¸‹è½½æ¨¡å‹**:
    ```bash
    # æ¨èï¼šä½¿ç”¨é­”å¡”ç¤¾åŒºä¸‹è½½
    python scripts/download_from_modelscope.py
    ```

### 3. è¿è¡Œé¡¹ç›®
æ¨èä½¿ç”¨ GPU è¿è¡Œï¼Œå¹¶æŒ‡å®šæœ¬åœ°æ¨¡å‹ä¸æ•°æ®è·¯å¾„ï¼š

```bash
# ç¤ºä¾‹ï¼šä½¿ç”¨ GPU è¿è¡Œï¼Œè´å¶æ–¯æœç´¢ï¼Œå°è¯• 30 æ¬¡ï¼Œç›®æ ‡å‹ç¼©æ¯” 0.8
python main.py --gpu \
  --model_path /path/to/Llama-2-7b-hf \
  --data_path /path/to/wikitext2/test.txt \
  --target_ratio 0.8 \
  --strategy bayesian \
  --n_trials 30
```

ç¨‹åºä¼šè‡ªåŠ¨ï¼š
1.  **åŠ è½½èµ„æº**: åŠ è½½æ¨¡å‹ä¸æ•°æ®ã€‚
2.  **è´å¶æ–¯æœç´¢**: ä½¿ç”¨ Optuna åœ¨å•æ–¹æ³•å’Œæ··åˆæ–¹æ³•ç©ºé—´ä¸­æ™ºèƒ½é‡‡æ ·ã€‚
3.  **çº¦æŸè¿‡æ»¤**: è‡ªåŠ¨å‰ªæä¸æ»¡è¶³ `target_ratio` çš„ç»„åˆã€‚
4.  **è¯„ä¼°ä¸æ‹©ä¼˜**: ç­›é€‰å‡º PPL æœ€ä½çš„é…ç½®ã€‚
5.  **ç”ŸæˆæŠ¥å‘Š**: åœ¨ `results/result_...` ä¸‹ç”Ÿæˆæ—¥å¿—ã€JSON æŠ¥å‘Šå’Œå¯è§†åŒ–å›¾ç‰‡ã€‚

### 4. å‘½ä»¤è¡Œå‚æ•°è¯¦è§£

```bash
python main.py [options]
```

*   `--model_path`: æœ¬åœ°æ¨¡å‹è·¯å¾„ (å¿…é¡»åŒ…å« config.json ç­‰æ–‡ä»¶)
*   `--data_path`: å¤–éƒ¨æ•°æ®é›†è·¯å¾„ (å¦‚ wikitext2 çš„ test.txt)
*   `--target_ratio`: ç›®æ ‡å‹ç¼©æ¯” (0.0-1.0)ï¼Œé»˜è®¤ 0.5ã€‚
*   `--strategy`: æœç´¢ç­–ç•¥ï¼Œå¯é€‰ `bayesian` (é»˜è®¤), `grid`, `random`ã€‚
*   `--n_trials`: è´å¶æ–¯æœç´¢çš„å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 30ã€‚
*   `--gpu`: å¼ºåˆ¶ä½¿ç”¨ GPU (æ¨è)ã€‚
*   `--cpu`: å¼ºåˆ¶ä½¿ç”¨ CPU (ææ…¢ï¼Œä»…ä¾›è°ƒè¯•)ã€‚
*   `--data_samples`: æ ¡å‡†æ ·æœ¬æ•°é‡ (é»˜è®¤ 10)ã€‚
*   `--save_to_local`: æ˜¯å¦ä¿å­˜æœ€ç»ˆå‹ç¼©åçš„æ¨¡å‹æ–‡ä»¶ã€‚

## ğŸ“Š ç»“æœåˆ†æ

è¿è¡Œç»“æŸåï¼Œæ£€æŸ¥ `results/result_xxx/picture/` ç›®å½•ï¼š
*   **search_space_analysis.png**: 
    *   ğŸ”µ è“è‰²ç‚¹ï¼šå•ä¸€æ–¹æ³•
    *   ğŸ”º çº¢è‰²ç‚¹ï¼šæ··åˆæ–¹æ³• (Hybrid)
    *   â­ é‡‘è‰²æ˜Ÿï¼šå¸•ç´¯æ‰˜æœ€ä¼˜è§£
    *   ä½ å¯ä»¥ç›´è§‚çœ‹åˆ°æ··åˆæ–¹æ³•æ˜¯å¦çªç ´äº†å•ä¸€æ–¹æ³•çš„æ€§èƒ½è¾¹ç•Œã€‚
*   **performance_analysis.png**: åŸå§‹æ¨¡å‹ vs å‹ç¼©æ¨¡å‹çš„æœ€ç»ˆ PPL å¯¹æ¯”ã€‚

æ£€æŸ¥ `results/result_xxx/run.log` æŸ¥çœ‹è¯¦ç»†çš„è¿è¡Œè¿‡ç¨‹å’Œé”™è¯¯ä¿¡æ¯ã€‚

## ğŸ› ï¸ å¦‚ä½•å¯¼å…¥æ–°çš„å‹ç¼©æ–¹æ³•ï¼Ÿ

æœ¬é¡¹ç›®é‡‡ç”¨**æ³¨å†Œæœºåˆ¶**ï¼Œæ·»åŠ æ–°ç®—æ³•åªéœ€ç®€å•ä¸‰æ­¥ï¼š

### ç¬¬ä¸€æ­¥ï¼šæ–°å»ºæ–‡ä»¶
åœ¨ `methods/pruning/` æˆ– `methods/quantization/` ä¸‹æ–°å»ºä¸€ä¸ª Python æ–‡ä»¶ï¼ˆä¾‹å¦‚ `my_pruning.py`ï¼‰ã€‚

### ç¬¬äºŒæ­¥ï¼šç¼–å†™ç®—æ³•ç±»
ç»§æ‰¿ `BaseCompressionMethod` å¹¶ä½¿ç”¨ `@register_method` è£…é¥°å™¨ã€‚

```python
# methods/pruning/my_pruning.py

from methods.base import BaseCompressionMethod
from methods.registry import register_method
import torch

# 1. ä½¿ç”¨è£…é¥°å™¨æ³¨å†Œå”¯ä¸€åç§°
@register_method("my_custom_pruning")
class MyCustomPruning(BaseCompressionMethod):
    
    # 2. å®ç°æ ¸å¿ƒå‹ç¼©é€»è¾‘
    def apply(self, model, **kwargs):
        threshold = kwargs.get("threshold", 0.1)
        print(f"Applying My Pruning with threshold {threshold}...")
        # ... è¿™é‡Œå†™ä½ çš„å‰ªæä»£ç  ...
        return model
        
    # 3. å®šä¹‰æœç´¢ç©ºé—´ (ä¾›è‡ªåŠ¨æœç´¢ä½¿ç”¨)
    def get_info(self):
        return {
            "type": "pruning", 
            "search_space": {
                "threshold": [0.1, 0.3, 0.5] # æœç´¢å¼•æ“ä¼šå°è¯•è¿™äº›å€¼
            }
        }
```

### ç¬¬ä¸‰æ­¥ï¼šæ¿€æ´»
åœ¨ `methods/pruning/__init__.py` ä¸­æ·»åŠ ä¸€è¡Œå¯¼å…¥ï¼š

```python
# methods/pruning/__init__.py
from .random import RandomPruning
from .my_pruning import MyCustomPruning  # <--- æ–°å¢è¿™è¡Œ
```

**å®Œæˆï¼** ä¸‹æ¬¡è¿è¡Œ `python main.py` æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ä½ çš„æ–°ç®—æ³•åŠ å…¥æœç´¢ç©ºé—´ã€‚

---
ç»´æŠ¤è€…ï¼šAutoLLM-Compressor é¡¹ç›®ç»„
